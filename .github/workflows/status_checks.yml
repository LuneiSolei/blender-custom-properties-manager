name: Documentation Status Checks

on:
  pull_request:
    branches: [ master, dev ]
  push:
    branches: [ master, dev ]
  workflow_dispatch:

permissions:
  id-token: write
  pages: write

jobs:
  build_docs_check:
    uses: ./.github/workflows/build_docs.yml
    with:
      event_name: ${{ github.event_name }}

  deploy_docs_check:
    needs: build_docs_check
    if: needs.build_docs_check.outputs.docs_changed == 'true' && github.ref == 'refs/heads/master'
    uses: ./.github/workflows/deploy_docs.yml
    with:
      artifact_name: ${{ needs.build_docs_check.outputs.artifact }}

  status_check:
    needs: [ build_docs_check, deploy_docs_check ]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check status
        run: |
          echo "Build Status: ${{ needs.build_docs_check.result }}"
          echo "Deploy Status: ${{ needs.deploy_docs_check.result }}"

          # Build must always succeed
          if [ "${{ needs.build_docs_check.result }}" != "success" ]; then
            echo "Build failed"
            exit 1
          fi

          # Deploy should succeed if it ran, or be skipped if not needed
          if [ "${{ needs.deploy_docs_check.result }}" != "success" ] && [ "${{ needs.deploy_docs_check.result }}" != "skipped" ]; then
            echo "Deploy failed"
            exit 1
          fi

          echo "All checks passed"
